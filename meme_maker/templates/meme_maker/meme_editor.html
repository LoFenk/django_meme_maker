{% extends meme_maker_base_template|default:"meme_maker/base.html" %}

{% block header_title %}Create Meme{% endblock %}
{% block header_subtitle %}{{ template.title }}{% endblock %}

{% block content %}
<div class="meme-editor-container">
    {# Preview Panel #}
    <div class="meme-editor-preview">
        <div class="meme-editor-preview-wrapper">
            <img src="{{ template.image.url }}" alt="{{ template.title }}" id="preview-image">
            <div class="meme-text-overlay meme-text-top" id="preview-top-text"></div>
            <div class="meme-text-overlay meme-text-bottom" id="preview-bottom-text"></div>
        </div>
    </div>
    
    {# Controls Panel #}
    <div class="meme-editor-controls">
        <h3>Add Your Text</h3>
        
        <form method="post" id="meme-editor-form">
            {% csrf_token %}
            
            <div class="meme-form-group">
                <label for="id_top_text" class="meme-form-label">Top Text</label>
                {{ form.top_text }}
            </div>
            
            <div class="meme-form-group">
                <label for="id_bottom_text" class="meme-form-label">Bottom Text</label>
                {{ form.bottom_text }}
            </div>
            
            <hr style="border: none; border-top: 1px solid #e5e7eb; margin: 1.5rem 0;">
            
            <h3 style="margin-bottom: 1rem;">Text Style</h3>
            
            <div class="meme-form-row">
                <div class="meme-form-group">
                    <label for="id_text_color" class="meme-form-label">Text Color</label>
                    {{ form.text_color }}
                </div>
                
                <div class="meme-form-group">
                    <label for="id_stroke_color" class="meme-form-label">Outline Color</label>
                    {{ form.stroke_color }}
                </div>
            </div>
            
            <div class="meme-form-group">
                <label for="id_font_size" class="meme-form-label">
                    Font Size: <span id="font-size-display">48</span>px
                </label>
                {{ form.font_size }}
            </div>
            
            <div class="meme-form-group">
                <div class="meme-checkbox-group">
                    {{ form.uppercase }}
                    <label for="id_uppercase" class="meme-form-label" style="margin: 0;">
                        UPPERCASE TEXT
                    </label>
                </div>
            </div>
            
            {{ form.text_overlays_json }}
            
            <button type="submit" class="meme-btn meme-btn-full">
                Create Meme →
            </button>
        </form>
        
        <div style="text-align: center; margin-top: 1rem;">
            <a href="{% url 'meme_maker:template_detail' template.pk %}" style="color: var(--meme-text-light); font-size: 0.9rem;">
                ← Back to template
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function() {
    // Get elements
    const topTextInput = document.getElementById('id_top_text');
    const bottomTextInput = document.getElementById('id_bottom_text');
    const textColorInput = document.getElementById('id_text_color');
    const strokeColorInput = document.getElementById('id_stroke_color');
    const fontSizeInput = document.getElementById('id_font_size');
    const uppercaseInput = document.getElementById('id_uppercase');
    const fontSizeDisplay = document.getElementById('font-size-display');
    
    const previewTopText = document.getElementById('preview-top-text');
    const previewBottomText = document.getElementById('preview-bottom-text');
    const previewImage = document.getElementById('preview-image');
    
    function updatePreview() {
        let topText = topTextInput.value;
        let bottomText = bottomTextInput.value;
        
        // Apply uppercase if checked
        if (uppercaseInput.checked) {
            topText = topText.toUpperCase();
            bottomText = bottomText.toUpperCase();
        }
        
        // Update text content
        previewTopText.textContent = topText;
        previewBottomText.textContent = bottomText;
        
        // Update colors
        const textColor = textColorInput.value;
        const strokeColor = strokeColorInput.value;
        
        // Calculate stroke width based on font size
        const fontSize = parseInt(fontSizeInput.value) || 48;
        const strokeWidth = Math.max(2, Math.floor(fontSize / 16));
        
        const textShadow = `
            ${strokeWidth}px ${strokeWidth}px 0 ${strokeColor},
            -${strokeWidth}px -${strokeWidth}px 0 ${strokeColor},
            ${strokeWidth}px -${strokeWidth}px 0 ${strokeColor},
            -${strokeWidth}px ${strokeWidth}px 0 ${strokeColor},
            0 ${strokeWidth}px 0 ${strokeColor},
            ${strokeWidth}px 0 0 ${strokeColor},
            0 -${strokeWidth}px 0 ${strokeColor},
            -${strokeWidth}px 0 0 ${strokeColor},
            0 ${strokeWidth + 3}px 6px rgba(0, 0, 0, 0.5)
        `;
        
        // Apply text color
        previewTopText.style.color = textColor;
        previewBottomText.style.color = textColor;
        
        // Apply text shadow (stroke effect)
        previewTopText.style.textShadow = textShadow;
        previewBottomText.style.textShadow = textShadow;
        
        // Apply font size - scale it relative to the preview image
        // The preview is smaller than the actual image, so we scale proportionally
        const previewWidth = previewImage.offsetWidth || 500;
        const scaleFactor = previewWidth / 800; // Assume 800px as reference width
        const scaledFontSize = Math.max(12, Math.round(fontSize * scaleFactor));
        
        previewTopText.style.fontSize = scaledFontSize + 'px';
        previewBottomText.style.fontSize = scaledFontSize + 'px';
        
        // Update font size display
        fontSizeDisplay.textContent = fontSize;
        
        // Apply text transform based on uppercase checkbox
        const textTransform = uppercaseInput.checked ? 'uppercase' : 'none';
        previewTopText.style.textTransform = textTransform;
        previewBottomText.style.textTransform = textTransform;
    }
    
    // Add event listeners
    topTextInput.addEventListener('input', updatePreview);
    bottomTextInput.addEventListener('input', updatePreview);
    textColorInput.addEventListener('input', updatePreview);
    strokeColorInput.addEventListener('input', updatePreview);
    fontSizeInput.addEventListener('input', updatePreview);
    uppercaseInput.addEventListener('change', updatePreview);
    
    // Update on window resize (for responsive font scaling)
    window.addEventListener('resize', updatePreview);
    
    // Also update when image loads (for correct sizing)
    previewImage.addEventListener('load', updatePreview);
    
    // Initial update
    updatePreview();
    
    // Update again after a short delay to ensure image is loaded
    setTimeout(updatePreview, 100);
})();
</script>
{% endblock %}
